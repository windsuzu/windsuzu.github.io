---
id: subpath-imports-in-rollup
title: Subpath Imports in Rollup
description: é€™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç´¹äº†å¦‚ä½•ä½¿ç”¨ subpath imports å¯¦ç¾å–®ç¨å°å…¥å…ƒä»¶çš„åŠŸèƒ½ï¼Œå–®ç¨ä½¿ç”¨æ¯å€‹å…ƒä»¶çš„æ™‚å€™ï¼Œä¸éœ€è¦å†å°å…¥æ•´å€‹å…ƒä»¶åº«ï¼Œå„ªåŒ–å…ƒä»¶åº«çš„æ•ˆèƒ½ã€‚é—œéµåœ¨æ–¼é€é rollup-plugin-generate-package-json ç­‰æ’ä»¶å’Œå‡½å¼ï¼Œåœ¨è¨­ç½® rollup.config.js æ™‚ç‚ºæ¯å€‹å…ƒä»¶å–®ç¨ç”Ÿæˆ index.jsã€index.d.ts å’Œ package.json æª”æ¡ˆã€‚
sidebar_label: ğŸŸ¨ Subpath Imports in Rollup
hide_title: true
hide_table_of_contents: false
tags: [rollup, subpath-imports, typescript, react, ui-library]
draft: false
last_update:
  date: 2022-10-17
---

<profile
  title="How to support subpath imports using React+Rollup+Typescript"
  url="https://medium.com/singapore-gds/how-to-support-subpath-imports-using-react-rollup-typescript-1d3d331f821b"
  author="Chong Lu Khei"
  level="intermediate"
  category={["other", "js/ts", "react/next"]}
/>

ç•¶æˆ‘å€‘æƒ³è¦é–‹ç™¼ä¸€å€‹ React UI library æ™‚ï¼Œå¤§éƒ¨åˆ†çš„æ•™å­¸éƒ½æœƒç›´æ¥å°‡æ‰€æœ‰çš„å…ƒä»¶é€é `index.ts` ä¾†åŒ¯å‡ºï¼Œé€™æ¨£çš„å¥½è™•æ˜¯ä½¿ç”¨è€…å¯ä»¥ç›´æ¥é€é `import { Button, Card, ... } from 'my-library'` ä¾†å¼•å…¥æ‰€æœ‰çš„å…ƒä»¶ã€‚ä½†æ˜¯é€™æ¨£çš„ç¼ºé»æ˜¯ï¼Œç•¶ library è¶Šä¾†è¶Šå¤§æ™‚ï¼Œæˆ‘å€‘æƒ³è¦å¼•å…¥æŸå€‹å…ƒä»¶ï¼Œå°±å¿…é ˆå°‡æ•´å€‹ library éƒ½å¼•å…¥é€²ä¾†ã€‚

æˆ‘å€‘å¯ä»¥åˆ©ç”¨ **subpath imports** ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚é€é `import { Button } from 'my-library/button'` ä¾†å¼•å…¥å–®ä¸€å…ƒä»¶ï¼Œè€Œä¸æ˜¯å°‡æ•´å€‹ library éƒ½å¼•å…¥ï¼Œå¯ä»¥æ¸›å°‘ bundle çš„å¤§å°ã€‚é€™å€‹æ•™å­¸æœƒä»¥ React + Rollup + Typescript ç‚ºä¾‹ï¼Œä¾†ä»‹ç´¹å¦‚ä½•ä»¥ subpath imports çš„æ–¹å¼æ‰“åŒ…ä¸€å€‹ React UI libraryã€‚

## The goal of the `dist` folder

æˆ‘å€‘å¸Œæœ›æœ€å¾Œæ‰“åŒ…å‡ºä¾†çš„ `dist` è³‡æ–™å¤¾èƒ½å¤ å‘ˆç¾ä»¥ä¸‹çš„æ¶æ§‹ï¼Œæ¯å€‹å…ƒä»¶éƒ½æ“æœ‰è‡ªå·±çš„è³‡æ–™å¤¾ï¼Œè£¡é¢åŒ…å«äº†è©²å…ƒä»¶çš„ `package.json`ã€`index.d.ts`ã€`index.js`ã€`index.js.map` ç­‰ç­‰ã€‚é€™æ¨£å¯ä»¥è®“ä½¿ç”¨è€…åœ¨å¼•å…¥å…ƒä»¶æ™‚ï¼Œåªéœ€è¦å¼•å…¥è©²å…ƒä»¶æ‰€å°æ‡‰çš„è³‡æ–™å¤¾å³å¯ï¼Œä¸éœ€è¦å°‡æ•´å€‹ library å¼•å…¥é€²ä¾†ã€‚ä¾‹å¦‚ `dist/Accordion` å’Œ `dist/Alert`ã€‚åŒæ™‚ï¼Œåœ¨æ•´å€‹ library çš„æ ¹ç›®éŒ„ä¸‹ï¼Œä¹Ÿéœ€è¦æœ‰ä¸€äº›æª”æ¡ˆå’Œè³‡æ–™å¤¾ï¼Œè™•ç†æ•´å€‹ library çš„ cjsã€esm å’Œ types definition çš„ entry point ä»¥åŠ `package.json` ç­‰ç­‰ã€‚

```js
dist
// highlight-next-line
â”œâ”€â”€ Accordion
â”‚   â”œâ”€â”€ Accordion.d.ts
â”‚   â”œâ”€â”€ AccordionBody.d.ts
â”‚   â”œâ”€â”€ AccordionButton.d.ts
â”‚   â”œâ”€â”€ AccordionCollapse.d.ts
â”‚   â”œâ”€â”€ AccordionContext.d.ts
â”‚   â”œâ”€â”€ AccordionHeader.d.ts
â”‚   â”œâ”€â”€ AccordionItem.d.ts
â”‚   â”œâ”€â”€ AccordionItemContext.d.ts
â”‚   â”œâ”€â”€ index.d.ts                // --> types definition entry point for Accordion component only
â”‚   â”œâ”€â”€ index.js                  // --> esm entry point for Accordion component only
â”‚   â”œâ”€â”€ index.js.map
â”‚   â””â”€â”€ package.json              // --> package.json for Accordion component only
// highlight-next-line
â”œâ”€â”€ Alert
â”‚   â”œâ”€â”€ Alert.d.ts
â”‚   â”œâ”€â”€ AlertHeading.d.ts
â”‚   â”œâ”€â”€ AlertLink.d.ts
â”‚   â”œâ”€â”€ index.d.ts
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ index.js.map
â”‚   â””â”€â”€ package.json
...
// error-next-line
â”œâ”€â”€ cjs
â”‚   â”œâ”€â”€ index.js        //--> cjs format entry point of whole library
â”‚   â””â”€â”€ index.js.map
// error-next-line
â”œâ”€â”€ index.d.ts
// error-next-line
â”œâ”€â”€ index.js            // --> esm format entry point of whole library
â”œâ”€â”€ index.js.map
// error-next-line
â”œâ”€â”€ package.json        // --> package.json file for the whole library
```

## Steps for Implementing Subpath Imports

æ¥ä¸‹ä¾†æˆ‘å€‘è¦æŒ‰ç…§ä»¥ä¸‹äº”å€‹æ­¥é©Ÿä¾†å¯¦ç¾ subpath importsï¼š

1. åœ¨æ¯å€‹å…ƒä»¶çš„è³‡æ–™å¤¾ä¸­å»ºç«‹ `index.ts` æª”æ¡ˆï¼Œç„¶å¾Œåœ¨è©²æª”æ¡ˆä¸­åŒ¯å‡ºè©²å…ƒä»¶å’Œ `props`ã€‚å¦å¤–ï¼Œåœ¨å°ˆæ¡ˆæœ€é ‚å±¤çš„ `index.ts` æª”æ¡ˆä¸­ä¹ŸåŒ¯å‡ºæ‰€æœ‰å…ƒä»¶çš„ `index.ts` æª”æ¡ˆã€‚é€™æ¨£ï¼Œæˆ‘å€‘çš„ UI library å°±å¯ä»¥ä½¿ç”¨å…©ç¨®æ–¹å¼å¼•å…¥å…ƒä»¶äº†ï¼š

- `import { Component } from 'my-ui-library/components'`
- `import { Component } from 'my-ui-library'`ã€‚

```jsx
// src/accordion/index.ts
export { Accordion } from "./accordion";
export type { AccordionProps } from "./accordion";
```

```jsx
// src/index.ts
export * from "./accordion";
export * from "./alert";
...
```

2. åœ¨ `tsconfig.json` ä¸­æŒ‡å®šè¼¸å‡ºçš„è·¯å¾‘å’Œ type çš„è·¯å¾‘ã€‚

```jsx
// ./tsconfig.json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "lib": ["dom", "esnext"],
    // output .d.ts declaration files for consumers
    "declaration": true,
    // highlight-next-line
    "declarationDir": "dist",
    // output .js.map sourcemap files for consumers
    "sourceMap": true,
    // highlight-next-line
    "rootDir": "src",
    ...
  },
  "include": ["src/**/*"],
  "exclude": [
    "node_modules",
    "build",
    "src/**/*.stories.tsx",
    "src/**/*.test.tsx"
  ]
}
```

3. åœ¨ `package.json` æª”æ¡ˆä¸­æŒ‡å®š `main`ã€`module` å’Œ `typings` çš„æ–‡ä»¶è·¯å¾‘ï¼Œé€™ä¸‰å€‹æ–‡ä»¶åˆ†åˆ¥ä»£è¡¨ä»¥ä¸‹å…§å®¹ï¼š

- `main`ï¼šæŒ‡å®šæ¨¡çµ„çš„å…¥å£æª”æ¡ˆè·¯å¾‘ã€‚
- `module`ï¼šè¡¨ç¤º ES6 æ¨¡çµ„çš„å…¥å£æª”æ¡ˆè·¯å¾‘ã€‚å¦‚æœé€™å€‹æ¬„ä½ä¸å­˜åœ¨ï¼ŒNode.js æœƒä½¿ç”¨ `main` æ¬„ä½ã€‚
- `typings`ï¼šæŒ‡å®š TypeScript å‹åˆ¥æª”æ¡ˆçš„è·¯å¾‘ã€‚

```jsx
// ./package.json
"scripts": {
	"rollup": "rm -rf dist && rollup -c",
	"build": "npm run rollup && npm run post:build",
	"post:build": "node ./scripts/frankBuild.js",
...
},
// highlight-start
"main": "dist/cjs/index.js",   // points to the entry point for cjs format of the library
"module": "dist/index.js",     // points to the entry point for esm format of the library
"typings": "dist/index.d.ts",  // points to the entry point for type definitions of the above two files
// highlight-end
```

4. ç‚ºäº†åœ¨æ‰“åŒ…çš„æ¯å€‹å…ƒä»¶ä¸­ç”Ÿæˆç¨ç«‹çš„ `index.js`ã€`index.d.ts` å’Œ `package.json` æª”æ¡ˆï¼Œæˆ‘å€‘éœ€è¦åœ¨ `rollup.config.js` ä¸­æ·»åŠ ä¸€äº›å‡½å¼ã€‚

- å®šç¾© `subfolderPlugins()` æ–¹æ³•ï¼Œç‚ºæ¯å€‹å…ƒä»¶å–®ç¨ç”Ÿæˆ `index.js`ã€`index.d.ts` å’Œ `package.json` æª”æ¡ˆã€‚
- å®šç¾© `folderBuilds()` æ–¹æ³•ï¼Œéæ­·æ‰€æœ‰å…ƒä»¶è³‡æ–™å¤¾ï¼Œç‚ºæ¯å€‹å…ƒä»¶ç”Ÿæˆè¼¸å‡ºã€‚

```jsx
// ./rollup.config.js
const plugins = [
  peerDepsExternal(),
  resolve(),
  commonjs(),
  typescript({
    tsconfig: "./tsconfig.json",
    useTsconfigDeclarationDir: true,
  }),
  terser(),
];

// Specify plugins for a given component
// If your folder structure is different than the author's, you will have to adjust it slightly.
// highlight-next-line
const subfolderPlugins = (folderName) => [
  ...plugins,
  generatePackageJson({
    baseContents: {
      name: `${packageJson.name}/${folderName}`,
      private: true,
      main: "../cjs/index.js", // --> points to cjs format entry point of whole library
      module: "./index.js", // --> points to esm format entry point of individual component
      types: "./index.d.ts", // --> points to types definition file of individual component
    },
  }),
];

// Loop through all component folders and generates the output for each component.
// If your folder structure is different than the author's, you will have to adjust it slightly.
// highlight-next-line
const folderBuilds = getFolders("./src").map((folder) => {
  return {
    input: `src/${folder}/index.ts`,
    output: {
      file: `dist/${folder}/index.js`,
      sourcemap: true,
      exports: "named",
      format: "esm",
    },
    plugins: subfolderPlugins(folder),
    external: ["react", "react-dom"],
  };
});

export default [
  {
    input: ["src/index.ts"],
    output: [
      {
        file: packageJson.module,
        format: "esm",
        sourcemap: true,
        exports: "named",
      },
      {
        file: packageJson.main,
        format: "cjs",
        sourcemap: true,
        exports: "named",
      },
    ],
    plugins,
    external: ["react", "react-dom"],
  },
  // highlight-next-line
  ...folderBuilds, // Generate outputs for all components by using the entry point of each component
];
```

5. åœ¨åŸ·è¡Œ `build` ä¹‹å¾Œï¼Œæˆ‘å€‘éœ€è¦å°‡ `package.json` ä¸­çš„ç›¸é—œå…§å®¹è¤‡è£½åˆ° `dist/package.json` ä¸­ã€‚ç‚ºæ­¤ï¼Œä½œè€…å»ºç«‹äº†ä¸€å€‹ `frankBuild.js` è…³æœ¬ä¾†å¯¦ç¾ã€‚ä½ å¯ä»¥[åœ¨æ­¤è™•æŸ¥çœ‹ç¨‹å¼ç¢¼ç‰‡æ®µ](https://gist.github.com/clukhei/38f64ffa79f2045b816c0696dc3add67)ã€‚

éµå¾ªä¸Šè¿°æ­¥é©Ÿå¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥å¯¦ç¾ subpath imports çš„åŠŸèƒ½ï¼Œå–®ç¨ä½¿ç”¨æ¯å€‹å…ƒä»¶çš„æ™‚å€™ï¼Œä¸éœ€è¦å†å°å…¥æ•´å€‹å…ƒä»¶åº«ï¼Œå„ªåŒ–å…ƒä»¶åº«çš„æ•ˆèƒ½ã€‚é—œéµåœ¨æ–¼é€é `rollup-plugin-generate-package-json` ç­‰æ’ä»¶å’Œå‡½å¼ï¼Œåœ¨è¨­ç½® `rollup.config.js` æ™‚ç‚ºæ¯å€‹å…ƒä»¶å–®ç¨ç”Ÿæˆ `index.js`ã€`index.d.ts` å’Œ `package.json` æª”æ¡ˆã€‚
