---
id: react-is-immutable
title: React is Immutable
description: é€™ç¯‡æ–‡ç« ä»‹ç´¹äº† mutationã€immutable çš„æ¦‚å¿µï¼Œä»¥åŠ React ç‚ºä»€éº¼è¦ç”¨ immutable çš„è³‡æ–™çµæ§‹ã€‚ç°¡è€Œè¨€ä¹‹ï¼ŒReact çš„ setState æœƒç”¨ Object.is() (ä¸€ç¨®é¡ä¼¼ === çš„**æ·ºå±¤æ¯”è¼ƒ**) ä¾†åˆ¤æ–· state æ˜¯å¦æœ‰è®ŠåŒ–ï¼Œä¸¦æ±ºå®šæ˜¯å¦è¦é‡æ–°æ¸²æŸ“ã€‚æ‰€ä»¥ï¼Œå¦‚æœåªæ˜¯ä¿®æ”¹ state çš„å…§å®¹ï¼Œè€Œæ²’æœ‰æ”¹è®Šå®ƒçš„åƒè€ƒä½ç½®ï¼ŒReact å°±ä¸æœƒé‡æ–°æ¸²æŸ“ã€‚é€™æ„å‘³è‘—ï¼Œæˆ‘å€‘ä¸èƒ½ç›´æ¥æ”¹è®Š state ä¾†è§¸ç™¼é‡æ–°æ¸²æŸ“ï¼Œè€Œæ˜¯è¦ç”¨ setState çµ¦å®ƒä¸€å€‹æ–°çš„å€¼ã€‚é€™å°±æ˜¯ React éœ€è¦ immutable çš„åŸå› ï¼Œå› ç‚ºæˆ‘å€‘è¦ç”¨è¤‡è£½å’Œä¿®æ”¹çš„æ–¹å¼ä¾†ç”¢ç”Ÿä¸€å€‹æ–°çš„ç‰©ä»¶æˆ–é™£åˆ—ï¼Œè®“ React èƒ½å¤ ç™¼ç¾ state çš„è®ŠåŒ–ã€‚
sidebar_label: ğŸŸ© React is Immutable
hide_title: true
hide_table_of_contents: false
keywords:
  - react
  - immutable
  - mutation
  - state
  - setState
  - Object.is
  - shallow compare
tags: [react, immutable, mutation, state]
draft: false
last_updated: 2023-04-02
---

<profile
  title="State in React is Immutable"
  url="https://reacttraining.com/blog/state-in-react-is-immutable"
  author="Brad Westfall"
  level="beginner"
  category={["react/next", "js/ts"]}
/>

é€™ç¯‡æ–‡ç« ä»‹ç´¹äº† mutationã€immutable çš„æ¦‚å¿µï¼Œä»¥åŠ React ç‚ºä»€éº¼è¦ç”¨ immutable çš„è³‡æ–™çµæ§‹ã€‚ç°¡è€Œè¨€ä¹‹ï¼ŒReact çš„ `setState` æœƒç”¨ `Object.is()` (ä¸€ç¨®é¡ä¼¼ `===` çš„**æ·ºå±¤æ¯”è¼ƒ**) ä¾†åˆ¤æ–· state æ˜¯å¦æœ‰è®ŠåŒ–ï¼Œä¸¦æ±ºå®šæ˜¯å¦è¦é‡æ–°æ¸²æŸ“ã€‚æ‰€ä»¥ï¼Œå¦‚æœåªæ˜¯ä¿®æ”¹ state çš„å…§å®¹ï¼Œè€Œæ²’æœ‰æ”¹è®Šå®ƒçš„åƒè€ƒä½ç½®ï¼ŒReact å°±ä¸æœƒé‡æ–°æ¸²æŸ“ã€‚é€™æ„å‘³è‘—ï¼Œæˆ‘å€‘ä¸èƒ½ç›´æ¥æ”¹è®Š state ä¾†è§¸ç™¼é‡æ–°æ¸²æŸ“ï¼Œè€Œæ˜¯è¦ç”¨ `setState` çµ¦å®ƒä¸€å€‹æ–°çš„å€¼ã€‚é€™å°±æ˜¯ React éœ€è¦ immutable çš„åŸå› ï¼Œå› ç‚ºæˆ‘å€‘è¦ç”¨è¤‡è£½å’Œä¿®æ”¹çš„æ–¹å¼ä¾†ç”¢ç”Ÿä¸€å€‹æ–°çš„ç‰©ä»¶æˆ–é™£åˆ—ï¼Œè®“ React èƒ½å¤ ç™¼ç¾ state çš„è®ŠåŒ–ã€‚

## Mutation in JavaScript

Object å’Œ Array æ˜¯ JavaScript ä¸­æœ€å¸¸è¦‹å¯ä»¥è¢«ã€Œmutateã€çš„è³‡æ–™çµæ§‹ã€‚Mutation æŒ‡çš„æ˜¯ç›´æ¥æ”¹è®Šç‰©ä»¶æˆ–é™£åˆ—çš„å…§å®¹ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å®ƒçš„åƒè€ƒä½ç½®ã€‚ä¾‹å¦‚æˆ‘å¯ä»¥ä¿®æ”¹ä¸€å€‹ç‰©ä»¶çš„å±¬æ€§ï¼Œç‚º `user` åŠ ä¸Šä¸€å€‹ `name` å±¬æ€§ã€‚

```js
const user = { name: "Brad" };
user.name = "Jay"; // ä¿®æ”¹äº† user é€™å€‹ç‰©ä»¶çš„ name å±¬æ€§
```

æˆ‘å€‘ä¹Ÿå¯ä»¥é€é `push` æˆ– `splice` ç­‰æ–¹æ³•ä¾†ç›´æ¥ä¿®æ”¹é™£åˆ—çš„å…§å®¹ã€‚

```js
const arr = [1, 2, 3];
arr.push(4); // åŠ å…¥ä¸€å€‹ 4ï¼Œè®Šæˆ [1, 2, 3, 4]
arr.splice(1, 1); // å¾ç´¢å¼• 1 é–‹å§‹ï¼Œåˆªé™¤ 1 å€‹å…ƒç´ ï¼Œè®Šæˆ [1, 3, 4]
```

:::tip Mutation / const
Mutation å’Œ const é—œéµå­—æ²’æœ‰é—œä¿‚ï¼Œå› ç‚º const åªæ˜¯é˜²æ­¢è®Šæ•¸è¢«é‡æ–°æŒ‡å®šï¼Œè€Œä¸æ˜¯é˜²æ­¢è®Šæ•¸çš„å…§å®¹è¢«æ”¹è®Šã€‚æ‰€ä»¥æˆ‘å€‘å¯ä»¥ä¿®æ”¹ const ç‰©ä»¶çš„å…§å®¹ï¼Œä½†ä¸èƒ½é‡æ–°æŒ‡å®šå®ƒã€‚

```js
const user = { name: "Brad" };
// error-start
user = { name: "Jay" }; // é€™æ¨£æœƒå ±éŒ¯ï¼Œå› ç‚º user ä¸èƒ½è¢«é‡æ–°æŒ‡å®š
user = 0; // é€™æ¨£ä¹Ÿæœƒå ±éŒ¯ï¼Œå› ç‚º user ä¸èƒ½è¢«é‡æ–°æŒ‡å®š
// error-end

const arr = [1, 2, 3];
// error-next-line
arr = [1, 2, 3, 4]; // é€™æ¨£æœƒå ±éŒ¯ï¼Œå› ç‚º arr ä¸èƒ½è¢«é‡æ–°æŒ‡å®š
```

:::

## Immutability

é€é mutations ç›´æ¥ä¿®æ”¹é™£åˆ—æˆ–ç‰©ä»¶ä¸¦æ²’æœ‰éŒ¯ï¼Œä½†æ˜¯æœ‰äº›äººèªç‚ºä½¿ç”¨ mutation ä¿®æ”¹è³‡æ–™ï¼Œé•·æœŸä¸‹ä¾†å¯èƒ½æœƒç”¢ç”Ÿä¸€äº› bugsï¼Œæ‰€ä»¥ä»–å€‘æœƒé¸æ“‡ä½¿ç”¨ **immutable strategy** ä¾†è™•ç†è³‡æ–™ã€‚Immutable strategy æŒ‡çš„æ˜¯ï¼Œæˆ‘å€‘ä¸æœƒç›´æ¥ä¿®æ”¹ç‰©ä»¶æˆ–é™£åˆ—ï¼Œè€Œæ˜¯è¤‡è£½ä¸€ä»½ï¼Œç„¶å¾Œä¿®æ”¹è¤‡è£½çš„è³‡æ–™ï¼Œæœ€å¾Œå›å‚³è¤‡è£½çš„è³‡æ–™ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ mutable å’Œ immutable çš„ç¯„ä¾‹ã€‚

```js
const user = { id: 1, name: "Brad" };

// mutable
user.name = "Jay";

// immutable - é€™è£¡æˆ‘å€‘ä½¿ç”¨äº†å±•é–‹é‹ç®—å­ï¼Œè¤‡è£½äº† user ä¸¦åŠ ä¸Š name å±¬æ€§
const newUser = { ...user, name: "Jay" };

// immutable - é€™è£¡æˆ‘å€‘ä½¿ç”¨äº† Object.assignï¼Œè¤‡è£½äº† user ä¸¦åŠ ä¸Š name å±¬æ€§
const newUser2 = Object.assign({}, user, { name: "Jay" });
```

:::tip Primitives are Immutable
JavaScript ä¸­çš„ primitive types (ä¾‹å¦‚ number, string, boolean) éƒ½æ˜¯ immutable çš„ï¼Œæ‰€ä»¥å®ƒå€‘è¢«ä¿®æ”¹ä¸€å®šéƒ½æ˜¯é€éé‡æ–°æŒ‡å®šè®Šæ•¸çš„æ–¹å¼ã€‚

```js
let num = 1;
num = 2; // é€™æ¨£å°±æ˜¯é‡æ–°æŒ‡å®š numï¼Œæ‰€ä»¥ num æœƒè®Šæˆ 2
```

:::

## Why is React state immutable?

ç¾åœ¨æˆ‘å€‘çŸ¥é“ä»€éº¼æ˜¯ mutable å’Œ immutableï¼Œå°±å¯ä»¥æ¸…æ¥šåœ°è§£æä¸‹é¢çš„ React ç¯„ä¾‹ç‚ºä»€éº¼æœƒæœ‰å•é¡Œã€‚åœ¨ä¸‹é¢çš„ç¯„ä¾‹ä¸­ï¼Œé›–ç„¶å° items çš„ push (mutation) æ˜¯æˆåŠŸçš„ï¼Œä½†ç”±æ–¼ React ç”¨ `Object.is()` ä¾†åˆ¤æ–· state æ˜¯å¦æœ‰è®ŠåŒ–ï¼Œæ‰€ä»¥ push å¾Œçš„ items å° React ä¾†èªªæ˜¯ä¸€æ¨£çš„ï¼Œå› æ­¤ React ä¸æœƒæ›´æ–° stateï¼Œä¹Ÿä¸æœƒé‡æ–°æ¸²æŸ“ã€‚

```jsx live noInline
const ItemList = () => {
  const [items, setItems] = useState([1, 2, 3]);
  return (
    <div>
      <button
        onClick={() => {
          items.push(4);
          console.log(items); // [1, 2, 3, 4]
          setItems(items); // not triggering a re-render
        }}
      >
        Add Item (Mutable)
      </button>
      <ul>
        {items.map((item) => (
          <li key={item}>{item}</li>
        ))}
      </ul>
    </div>
  );
};

render(<ItemList />);
```

å¦‚æœæˆ‘å€‘è¦è®“ React é‡æ–°æ¸²æŸ“ï¼Œå°±å¿…é ˆä½¿ç”¨ immutable çš„æ–¹å¼ä¾†æ›´æ–° stateã€‚é€éå±•é–‹é‹ç®—å­ï¼Œæˆ‘å€‘å¯ä»¥è¤‡è£½ä¸€ä»½ itemsï¼Œç„¶å¾Œå°è¤‡è£½çš„ items æ·»åŠ ä¸€å€‹å…ƒç´  (é¡ä¼¼æ–¼ `items.push(4)`)ï¼Œæœ€å¾Œå†å›å‚³è¤‡è£½çš„ itemsã€‚å› æ­¤ï¼ŒReact æœƒåˆ¤æ–·åˆ° state æœ‰è®ŠåŒ–ï¼Œæ‰€ä»¥æœƒé‡æ–°æ¸²æŸ“ã€‚

```jsx live noInline
const ItemList = () => {
  const [items, setItems] = useState([1, 2, 3]);
  return (
    <div>
      <button
        onClick={() => {
          setItems([...items, 4]); // triggering a re-render
          // setItems(items.concat(4)); also works
        }}
      >
        Add Item (Immutable)
      </button>
      <ul>
        {items.map((item) => (
          <li key={item}>{item}</li>
        ))}
      </ul>
    </div>
  );
};

render(<ItemList />);
```

### Primitives in React state

å¦‚æœæˆ‘å€‘ç›´æ¥ä¿®æ”¹ primitive é¡åˆ¥çš„ stateï¼ŒReact å…¶å¯¦æœƒé‡æ–°æ¸²æŸ“ï¼é€™æ˜¯å› ç‚º `count++` æ”¹è®Šäº† count çš„åƒè€ƒä½ç½®ï¼Œç„¶å¾Œ React åˆ¤æ–· state æœ‰è®ŠåŒ–ï¼Œæ‰€ä»¥æ›´æ–°äº† state ä¸¦é‡æ–°æ¸²æŸ“ã€‚

ä½†æˆ‘å€‘ä¸æ‡‰è©²ä½¿ç”¨ `count++`ï¼Œå› ç‚ºé€™å¯èƒ½æœƒè®“äººèª¤æœƒ mutations æ˜¯å¯ä»¥çš„ã€‚æˆ‘å€‘æ‡‰è©²ä½¿ç”¨ `setCount(count + 1)`ï¼Œé€™æ¨£æ¯”è¼ƒæ¸…æ¥šåœ°è¡¨é”æˆ‘å€‘ä¸æœƒç›´æ¥ä¿®æ”¹ stateï¼Œè€Œæ˜¯é€éå‚³å…¥æ–°çš„å€¼ä¾†é‡æ–°æ¸²æŸ“ã€‚æ‰€ä»¥æˆ‘å€‘æ‡‰è©²æ›ä¸€å€‹æ›´ç²¾ç¢ºçš„èªªæ³•ï¼Œå°±æ˜¯ã€Œä¸è¦ç›´æ¥ä¿®æ”¹ stateã€ã€‚

```jsx live noInline
const Counter = () => {
  let [count, setCount] = useState(0);
  return (
    <div>
      <button
        onClick={() => {
          count++; // IT ACTUALLY WORKS! But don't do this.
          setCount(count); // triggering a re-render
        }}
      >
        Increment
      </button>
      <p>Count: {count}</p>
    </div>
  );
};

render(<Counter />);
```

:::tip we should not mutate props
æˆ‘å€‘æ›´ä¸è©²ç›´æ¥ä¿®æ”¹ propsï¼Œå› ç‚º props æ˜¯ immutable çš„ã€‚Props é€šå¸¸æ˜¯ç”±çˆ¶å…ƒä»¶å‚³å…¥ï¼Œä½†æ˜¯ç›´æ¥ä¿®æ”¹ props ä¸¦ä¸æœƒè®“ React é‡æ–°æ¸²æŸ“ï¼Œå¯èƒ½è®“çˆ¶å…ƒä»¶çš„ state èˆ‡å­å…ƒä»¶çš„ props ä¸ä¸€è‡´ï¼Œæœ€çµ‚å°è‡´é æœŸçš„çµæœèˆ‡å¯¦éš›çµæœä¸ä¸€è‡´ã€‚

```jsx
const ItemList = ({ items }) => {
  // error-next-line
  items.push(4); // this is not allowed
  return <>{items}</>;
};
```

:::
