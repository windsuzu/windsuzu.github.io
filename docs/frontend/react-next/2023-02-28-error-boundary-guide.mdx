---
id: error-boundary-guide
title: ErrorBoundary Guide
description: åœ¨ React ä¸­ï¼Œæˆ‘å€‘ç„¡æ³•å°‡æ•´å€‹ useEffect æˆ–å­å…ƒç´ è£åœ¨ try/catch ä¾†æ•ç²éŒ¯èª¤ï¼Œä½†æˆ‘å€‘å¯ä»¥ä½¿ç”¨ ErrorBoundary ä¾†å¯¦ç¾é€™ä¸€é»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒErrorBoundary ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚ç„¡æ³•æ•ç²éåŒæ­¥éŒ¯èª¤æˆ–äº‹ä»¶è™•ç†ä¸­çš„éŒ¯èª¤ã€‚ä½†æˆ‘å€‘å¯ä»¥åœ¨ catch å€å¡Šä¸­å¼·åˆ¶å°‡ React é‡æ–°æ¸²æŸ“ï¼Œç„¶å¾ŒæŠŠéŒ¯èª¤ä¸Ÿå›é‡æ–°æ¸²æŸ“çš„ç”Ÿå‘½é€±æœŸä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚
sidebar_label: ğŸŸ© ErrorBoundary Guide
hide_title: true
hide_table_of_contents: false
tags: [react, js, error-boundary]
draft: false
last_updated: 2023-02-28
---

<profile
  title="How to handle errors in React: full guide"
  url="https://www.developerway.com/posts/how-to-handle-errors-in-react"
  author="NADIA MAKAREVICH"
  level="beginner"
  category={["react/next", "js/ts"]}
/>

æœ¬æ–‡ä»‹ç´¹äº† React ä¸­è™•ç†éŒ¯èª¤çš„å…©ç¨®æ–¹å¼ï¼šä½¿ç”¨ `try/catch` å’Œ `ErrorBoundary`ï¼Œä»¥åŠå®ƒå€‘å„è‡ªçš„é™åˆ¶ã€‚ä½¿ç”¨ `try/catch` æ™‚ï¼Œå®ƒç„¡æ³•æ•ç² `hooks` å’Œå­çµ„ä»¶ä¸­çš„éŒ¯èª¤ã€‚ä½¿ç”¨ `ErrorBoundary` æ™‚ï¼Œå®ƒç„¡æ³•æ•ç²**ç•°æ­¥ä»£ç¢¼ (async code)** å’Œ**äº‹ä»¶è™•ç†ç¨‹åº (event handler)** ä¸­çš„éŒ¯èª¤ã€‚ä½†æ˜¯ï¼Œå¯ä»¥é€šéåœ¨ `try/catch` ä¸­æ•ç²éŒ¯èª¤ï¼Œç„¶å¾Œå°‡éŒ¯èª¤é‡æ–°æŠ›å‡ºåˆ° React çš„ç”Ÿå‘½é€±æœŸä¸­ï¼Œä½¿ `ErrorBoundary` èƒ½å¤ æ•ç²é€™äº›éŒ¯èª¤ã€‚

## Why do we need to catch errors in React?

ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦åœ¨ React ä¸­æ•ç²éŒ¯èª¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å› ç‚ºå¾ React 16 é–‹å§‹ï¼Œå¦‚æœæ²’æœ‰æ•ç²éŒ¯èª¤ï¼ŒReact æœƒç›´æ¥åœ¨ç”Ÿå‘½é€±æœŸä¸­æŠ›å‡ºéŒ¯èª¤ï¼Œåœæ­¢æ•´å€‹æ‡‰ç”¨ç¨‹åºï¼Œä¸¦è·³å‡ºéŒ¯èª¤é é¢ã€‚å› æ­¤ï¼Œå³ä½¿éŒ¯èª¤ç™¼ç”Ÿåœ¨ UI ä¸­çš„æŸå€‹ä¸é‡è¦çš„éƒ¨åˆ†ï¼Œæˆ–è€…æ˜¯æŸå€‹ä½ ç„¡æ³•æ§åˆ¶çš„ç¬¬ä¸‰æ–¹åº«ä¸­ï¼Œå¦‚æœæ²’æœ‰æ•ç²éŒ¯èª¤ï¼Œæ•´å€‹é é¢éƒ½æœƒè¢«éŠ·æ¯€ï¼Œä¸¦ä¸”å‘ä½¿ç”¨è€…é¡¯ç¤ºéŒ¯èª¤é é¢ã€‚

## Review: Catching Errors in JavaScript

åœ¨ JavaScript ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `try/catch` ä¾†æ•ç²éŒ¯èª¤ã€‚å¦‚æœåœ¨ `try` ä¸­çš„ä»£ç¢¼ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œå‰‡å¯ä»¥æ•ç²éŒ¯èª¤ï¼Œä¸¦åœ¨ `catch` ä¸­è™•ç†éŒ¯èª¤ã€‚é€™å€‹æ–¹æ³•é©ç”¨æ–¼åŒæ­¥ç¨‹å¼ç¢¼ï¼Œä¹Ÿé©ç”¨æ–¼éåŒæ­¥ç¨‹å¼ç¢¼ã€‚æˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨ `Promise.then()` å’Œ `Promise.catch()` ä¾†æ•ç²éåŒæ­¥çš„éŒ¯èª¤ï¼Œä½†é€™ç¯‡æ–‡ç« ä»¥ `try/catch` ç‚ºä¸»ã€‚

<div style={{columns: "20rem"}}>

```js title="Catch synchronous errors"
try {
  doSomethingWrong();
} catch (error) {
  // handle error
}
```

```js title="Catch asynchronous errors"
try {
  await fetch("/bla-bla");
} catch (error) {
  // handle error
}
```

</div>

## Problems of `try/catch` in React

åœ¨ React ä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ `try/catch` ä¾†æ•ç²éŒ¯èª¤ã€‚ä½†æ˜¯ï¼Œä»¥ä¸‹æ˜¯ä¸‰ç¨®éŒ¯èª¤çš„ä½¿ç”¨æ–¹å¼ï¼š

### 1. Catch errors in `useEffect`

å°‡ `useEffect` æ•´å€‹æ”¾åœ¨ `try/catch` ä¸­æ˜¯éŒ¯èª¤çš„ã€‚ç”±æ–¼ `useEffect` æ˜¯åœ¨ render å¾ŒéåŒæ­¥åŸ·è¡Œï¼Œæ‰€ä»¥å°æ–¼ `try/catch` ä¾†èªªæ°¸é éƒ½æ˜¯æˆåŠŸåŸ·è¡Œï¼Œä¹Ÿå°±æ°¸é æŠ“ä¸åˆ° `useEffect` ä¸­çš„éŒ¯èª¤ã€‚

```js title="Catch errors in hooks âŒ"
const Component = () => {
  try {
    useEffect(() => {
      doSomethingWrong();
    }, []);
  } catch (error) {
    // never triggered
  }
  return <div />;
};
```

### 2. Catch errors in `children`

å°‡ `children` æ•´å€‹æ”¾åœ¨ `try/catch` ä¸­æ˜¯éŒ¯èª¤çš„ã€‚ä¸ç®¡æ˜¯åœ¨ `try/catch` ä¸­å®šç¾© `children`ï¼Œé‚„æ˜¯ç›´æ¥åœ¨ `try/catch` ä¸­è¿”å› `children`ï¼Œéƒ½æ˜¯éŒ¯èª¤çš„ã€‚ é€™æ˜¯å› ç‚ºç•¶ç¨‹å¼åŸ·è¡Œåˆ° `<Child />` æ™‚ï¼Œå®ƒä¸¦ä¸æ˜¯çœŸæ­£çš„æ¸²æŸ“å…ƒä»¶ï¼Œè€Œæ˜¯å‰µå»ºäº†ä¸€å€‹å…ƒä»¶å…ƒç´ ã€‚é€™å€‹å…ƒç´ åªæ˜¯ä¸€å€‹åŒ…å«å…ƒä»¶é¡å‹å’Œå±¬æ€§çš„å°è±¡ï¼Œè€Œä¸”æœƒåœ¨ `try/catch` åŸ·è¡ŒæˆåŠŸå¾Œï¼Œåœ¨ React ä¸­è¢«ä½¿ç”¨ï¼Œèˆ‡ `useEffect` çš„æƒ…æ³é¡ä¼¼ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ç„¡æ³•æ•ç²éŒ¯èª¤çš„ã€‚

<div style={{columns:"20rem"}}>

```js title="Catch errors in children âŒ"
const Component = () => {
  let child;

  try {
    child = <Child />;
  } catch (e) {
    // never triggered
  }
  return child;
};
```

```js title="Catch errors in children âŒ"
const Component = () => {
  try {
    return <Child />;
  } catch (e) {
    // never triggered
  }
};
```

</div>

### 3. Catch errors in `render` and Change state

åœ¨ `render` ä¸­ä½¿ç”¨ `try/catch` ä¾†æ•ç²éŒ¯èª¤ï¼Œä¸¦åœ¨ `catch` ä¸­æ”¹è®Š `state`ï¼Œé€™æ˜¯éŒ¯èª¤çš„ã€‚é€™æ˜¯å› ç‚º `render` æ˜¯åŒæ­¥åŸ·è¡Œçš„ï¼Œæ‰€ä»¥ `try/catch` æœƒæ•ç²åˆ°éŒ¯èª¤ï¼Œä½†æ˜¯åœ¨ `catch` ä¸­æ”¹è®Š `state` æœƒå°è‡´ç„¡é™å¾ªç’°ï¼Œå› ç‚º `render` æœƒå†æ¬¡è¢«èª¿ç”¨ï¼Œé€²è€Œå†æ¬¡è§¸ç™¼ `try/catch`ã€‚

```js title="Change state in render âŒ"
const Component = () => {
  const [hasError, setHasError] = useState(false);

  try {
    doSomethingComplicated();
  } catch (e) {
    // will cause infinite loop
    setHasError(true);
  }
};
```

## ErrorBoundary in React

ç‚ºäº†è§£æ±ºä¸Šè¿°å•é¡Œï¼ŒReact æä¾›äº† `ErrorBoundary` é€™å€‹**ã€Œæ¦‚å¿µã€** ä¾†æ•ç²éŒ¯èª¤ã€‚æˆ‘å€‘å¿…é ˆä½¿ç”¨èˆŠç‰ˆçš„ class component è‡ªè¡Œå¯¦ç¾ä¸€å€‹ `ErrorBoundary`ï¼Œç„¶å¾Œä½¿ç”¨å®ƒä¾†åŒ…ä½å¯èƒ½æœƒç™¼ç”ŸéŒ¯èª¤çš„å…ƒä»¶ã€‚é€™å€‹ `ErrorBoundary` å…ƒä»¶åŒ…å«äº†å¹¾å€‹ç”Ÿå‘½é€±æœŸæ–¹æ³•ï¼Œä¾‹å¦‚

- `constructor` æœƒåˆå§‹åŒ–ä¸€å€‹ `state`ï¼Œç”¨ä¾†å­˜æ”¾æ˜¯å¦ç™¼ç”ŸéŒ¯èª¤
- `static getDerivedStateFromError` æœƒåœ¨ `render` ä¸­ç™¼ç”ŸéŒ¯èª¤æ™‚è¢«èª¿ç”¨ï¼Œä¸¦å°‡ `state` ä¸­çš„ `hasError` è¨­ç½®ç‚º `true`ï¼Œæˆ‘å€‘å°±å¯ä»¥æ ¹æ“š `hasError` ä¾†æ¸²æŸ“éŒ¯èª¤è¨Šæ¯ã€‚é€™å€‹æ–¹æ³•æ˜¯ç”¢ç”Ÿ ErrorBoundary çš„å¿…è¦æ–¹æ³•
- `componentDidCatch` å¯ä»¥å°‡éŒ¯èª¤è¨Šæ¯åŠ ä»¥åˆ©ç”¨ï¼Œä¾‹å¦‚ç™¼é€åˆ°å¾Œç«¯ï¼Œæˆ–è€…ä½¿ç”¨ `Sentry` ä¾†æ•ç²éŒ¯èª¤

å¦å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªå®šç¾© `ErrorBoundary` çš„ `fallback`ï¼Œé€™å€‹ `fallback` æœƒåœ¨ `render` ä¸­ç™¼ç”ŸéŒ¯èª¤æ™‚è¢«æ¸²æŸ“ã€‚

```js title="ErrorBoundary Example" live noInline
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    // initialize the error state
    this.state = { hasError: false };
  }

  // if an error happened, set the state to true
  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    // send error to somewhere here
    console.log(error, errorInfo);
  }

  render() {
    // if error happened, return a fallback component
    if (this.state.hasError) {
      return this.props.fallback || <>Oh no! Something went wrong!</>;
    }

    return this.props.children;
  }
}

const ErrorComponent = () => {
  const [counter, setCounter] = useState(0);

  useEffect(() => {
    if (counter > 0) throw new Error("error");
  }, [counter]);

  return (
    <button onClick={() => setCounter((prev) => prev + 1)}>Click me</button>
  );
};

render(
  <ErrorBoundary fallback={<>Wow it is broken!</>}>
    <ErrorComponent />
  </ErrorBoundary>
);
```

## ErrorBoundary with Asynchronous Error

ä¸Šé¢æˆ‘å€‘æ‰€å¯«çš„ `ErrorBoundary` æœ‰ä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚æˆ‘å€‘ä¸èƒ½é€é `ErrorBoundary` ä¾†æ•ç²éåŒæ­¥çš„éŒ¯èª¤ï¼Œä¾‹å¦‚ `setTimeout`ã€`Promise`ï¼›æˆ‘å€‘ä¹Ÿç„¡æ³•é€é `ErrorBoundary` ä¾†æ•ç² Event Handler, Callback ä¸­çš„éŒ¯èª¤ï¼Œä¾‹å¦‚ `onClick`ã€`onSubmit`ã€‚

<div style={{columns:"20rem"}}>

```js title="can't catch errors from event handler âŒ"
const onClick = () => {
  // this error will disappear into the void
  throw new Error("Hulk smash!");
};
```

```js title="can't catch errors from async function âŒ"
useEffect(() => {
  //the error will also disappear
  fetch("/bla");
}, []);
```

</div>

ä¸éåœ¨ [Throwing Error from hook not caught in error boundary Â· Issue #14981 Â· facebook/react](https://github.com/facebook/react/issues/14981#issuecomment-468460187). ä¸­ï¼Œ[Dan Abramov](https://twitter.com/dan_abramov) æä¾›äº†ä¸€å€‹è§£æ±ºæ–¹æ¡ˆã€‚æˆ‘å€‘å¯ä»¥å…ˆåœ¨ `try/catch` ä¸­æ•ç²éŒ¯èª¤ï¼Œç„¶å¾Œåœ¨ `catch` ä¸­è§¸ç™¼ä¸€æ¬¡ React é‡æ–°æ¸²æŸ“ï¼Œæœ€å¾Œå†å°‡éŒ¯èª¤ä¸Ÿå›é‡æ–°æ¸²æŸ“çš„ç”Ÿå‘½é€±æœŸä¸­ã€‚é€™æ¨£ `ErrorBoundary` å°±å¯ä»¥åƒå…¶ä»–éŒ¯èª¤ä¸€æ¨£æ•ç²å®ƒå€‘ã€‚ç”±æ–¼ `useState` çš„æ›´æ–°æ˜¯è§¸ç™¼é‡æ–°æ¸²æŸ“çš„æ–¹å¼ï¼Œè€Œ `useState` çš„è¨­ç½®å‡½æ•¸å¯ä»¥æ¥å—ä¸€å€‹æ›´æ–°å‡½æ•¸ä½œç‚ºåƒæ•¸ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ä½¿ç”¨é€™å€‹æ›´æ–°å‡½æ•¸ä¾†é‡æ–°ä¸Ÿå‡ºéŒ¯èª¤ã€‚

```js title="ErrorBoundary Example" live noInline
// this is a custom hook to throw error in async function
const useThrowAsyncError = () => {
  const [state, setState] = useState();
  return (error) => {
    setState(() => {
      throw error;
    });
  };
};

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  render() {
    if (this.state.hasError) {
      return <>Oh no! Something went wrong!</>;
    }
    return this.props.children;
  }
}

const ErrorComponent = () => {
  const throwAsyncError = useThrowAsyncError();
  return (
    <button
      onClick={() => {
        try {
          throw new Error("error");
        } catch (e) {
          // this will trigger React to re-render
          // and throw the error again
          throwAsyncError(e);
        }
      }}
    >
      Click me
    </button>
  );
};

render(
  <ErrorBoundary fallback={<>Wow it is broken!</>}>
    <ErrorComponent />
  </ErrorBoundary>
);
```

## Conclusion

åœ¨ React ä¸­ï¼Œæˆ‘å€‘ç„¡æ³•é€é `try/catch` åŒ…ä½æ•´å€‹ `useEffect` æˆ–æ˜¯å­å…ƒä»¶ `children` ä¾†æ•ç²éŒ¯èª¤ï¼Œä½†æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `ErrorBoundary` ä¾†é”æˆã€‚ä¸é `ErrorBoundary` ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚å®ƒç„¡æ³•æ•ç²éåŒæ­¥çš„éŒ¯èª¤ï¼Œä¾‹å¦‚ `setTimeout`ã€`Promise`ï¼›å®ƒä¹Ÿç„¡æ³•æ•ç² Event Handler, Callback ä¸­çš„éŒ¯èª¤ï¼Œä¾‹å¦‚ `onClick`ã€`onSubmit`ã€‚ä¸éæˆ‘å€‘å¯ä»¥ä½¿ç”¨ä¸€å€‹è‡ªå®šç¾©çš„ `useThrowAsyncError` ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚æˆ‘å€‘å¯ä»¥åœ¨ `catch` ä¸­ä½¿ç”¨ `useThrowAsyncError` å¼·åˆ¶è§¸ç™¼ React é‡æ–°æ¸²æŸ“ï¼Œæœ€å¾Œå†å°‡éŒ¯èª¤ä¸Ÿå›é‡æ–°æ¸²æŸ“çš„ç”Ÿå‘½é€±æœŸä¸­ã€‚

å¦å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥è€ƒæ…®ä½¿ç”¨ [bvaughn/react-error-boundary](https://github.com/bvaughn/react-error-boundary) é€™å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚é€™å€‹å¥—ä»¶æä¾›äº† `<ErrorBoundary>` ä»¥åŠ `useErrorHandler`ï¼Œè®“æˆ‘å€‘æ›´æ–¹ä¾¿çš„ä½¿ç”¨ `ErrorBoundary` çš„æ–¹å¼æ•æ‰éŒ¯èª¤ã€‚
