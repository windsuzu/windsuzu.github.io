---
id: garbage-collector-experiment
title: Garbage Collector Experiment
description: Garbage Collector (GC) æ˜¯ JS ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä½†æ˜¯å®ƒçš„è¡Œç‚ºä¸¦ä¸æ˜¯å¾ˆå®¹æ˜“è®“æˆ‘å€‘ debugï¼Œé€™ç¯‡æ–‡ç« ä½¿ç”¨äº† `FinalizationRegistry` ä¾†è§€å¯Ÿ GC çš„è¡Œç‚ºã€‚å¦‚æœä½ é‚„ä¸ç†Ÿæ‚‰ GC çš„æ¦‚å¿µï¼Œå¯ä»¥å…ˆé–±è®€ç”± Lin Clark å¯«çš„ [A Crash Course in Memory Management](https://hacks.mozilla.org/2017/06/a-crash-course-in-memory-management/)ã€‚
sidebar_label: ğŸŸ¨ Garbage Collector Experiment
hide_title: true
hide_table_of_contents: false
tags: [javascript, garbage-collector, finalization-registry]
draft: false
last_update:
  date: 2023-03-05
---

<profile
  title="Experiments with the JavaScript Garbage Collector"
  url="https://dev.to/codux/experiments-with-the-javascript-garbage-collector-2ae3"
  author="Alexey Lebedev"
  level="intermediate"
  category={["js/ts"]}
/>

Garbage Collector (GC) æ˜¯ JS ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä½†æ˜¯å®ƒçš„è¡Œç‚ºä¸¦ä¸æ˜¯å¾ˆå®¹æ˜“è®“æˆ‘å€‘ debugï¼Œé€™ç¯‡æ–‡ç« ä½¿ç”¨äº† `FinalizationRegistry` ä¾†è§€å¯Ÿ GC çš„è¡Œç‚ºã€‚å¦‚æœä½ é‚„ä¸ç†Ÿæ‚‰ GC çš„æ¦‚å¿µï¼Œå¯ä»¥å…ˆé–±è®€ç”± Lin Clark å¯«çš„ [A Crash Course in Memory Management](https://hacks.mozilla.org/2017/06/a-crash-course-in-memory-management/)ã€‚

## Detecting Object Disposal

`FinalizationRegistry` æ˜¯ä¸€å€‹æ”¯æ´ä¸»æµ browser å’Œ Node.js çš„ APIï¼Œå®ƒå¯ä»¥è®“æˆ‘å€‘åœ¨ç‰©ä»¶è¢«å›æ”¶æ™‚åŸ·è¡Œä¸€äº›ç¨‹å¼ç¢¼ã€‚å®ƒçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼šåœ¨åº•ä¸‹çš„ç¨‹å¼ç¢¼ä¸­ï¼Œç”±æ–¼ `x` åœ¨ `example()` åŸ·è¡Œå®Œå¾Œä¸å†è¢«å¼•ç”¨ï¼Œå› æ­¤å®ƒå°‡è¢«å›æ”¶ã€‚ç•¶ `x` è¢«å›æ”¶æ™‚ï¼Œ`FinalizationRegistry` æœƒåŸ·è¡Œ `console.log(message)`ã€‚

```js live noInline
const registry = new FinalizationRegistry((message) => console.log(message));

function example() {
  console.log("example() is running, waiting for GC...");

  const x = {};
  registry.register(x, "x has been collected");
}

render(<button onClick={example}>Open console and click me</button>);
```

```bash title="The output in the console will be:"
example() is running, waiting for GC...
x has been collected
```

é€šå¸¸æƒ…æ³ä¸‹ï¼Œ`x` ä¸¦ä¸æœƒé¦¬ä¸Šè¢«å›æ”¶ï¼Œå› ç‚ºç€è¦½å™¨çš„ engine å¯èƒ½æœƒæœ‰å…¶ä»–æ›´é‡è¦çš„äº‹æƒ…éœ€è¦å…ˆå®Œæˆã€‚ä½†æˆ‘å€‘å¯ä»¥é€é `DevTools > Memory > collect garbage icon` ä¾†å¼·åˆ¶è§¸ç™¼ GCã€‚

<fig
  src="/img/reading/js-ts/2023-03-05-garbage-collector-experiment/devtool_gc.png"
  caption="DevTools > Memory > collect garbage icon"
/>

## Example 1: Nested Object

åœ¨ç¬¬ä¸€å€‹ç¯„ä¾‹ï¼Œæˆ‘å€‘å˜—è©¦å°‡ `x` è¨­ç‚º `z` çš„å±¬æ€§ï¼Œä¸¦ä¸”å°‡ `x` è¨­ç‚º `globalThis.temp` çš„å€¼ã€‚åœ¨ `example()` åŸ·è¡Œå®Œä¸€æ®µæ™‚é–“å¾Œï¼Œ`z` å’Œ `y` æœƒä¸å†è¢«ä»»ä½•æ±è¥¿å¼•ç”¨ï¼Œå› æ­¤å®ƒå€‘å°‡æœƒè¢«å›æ”¶ã€‚ä½† `x` ä»ç„¶è¢« `globalThis.temp` å¼•ç”¨ï¼Œå› æ­¤å®ƒä¸æœƒè¢«å›æ”¶ã€‚å¦‚æœæˆ‘å€‘å°‡ `globalThis.temp` è¨­ç‚º `undefined`ï¼Œå‰‡ `x` ä¹Ÿå°‡è¢«å›æ”¶ã€‚

```js live noInline
const registry = new FinalizationRegistry((message) => console.log(message));

function example() {
  console.log("example() is running, waiting for GC...");

  const x = {};
  const y = {};
  const z = { x, y };
  registry.register(x, "x has been collected");
  registry.register(y, "y has been collected");
  registry.register(z, "z has been collected");

  globalThis.temp = x;
}

render(<button onClick={example}>Open console and click me</button>);
```

```bash title="The output in the console will be:"
example() is running, waiting for GC...
z has been collected
y has been collected
```

## Example 2: Closure

åœ¨ç¬¬äºŒå€‹ç¯„ä¾‹ï¼Œæˆ‘å€‘å°‡ `z.x` è¨­ç‚º `globalThis.temp` çš„å€¼ã€‚æ–¼æ˜¯åœ¨ `example()` åŸ·è¡Œå®Œå¾Œï¼Œæˆ‘å€‘å°‡æ²’è¾¦æ³•å†å–å¾— `z` å’Œ `y`ã€‚

ç…§ç†ä¾†èªªï¼Œ`z` å’Œ `y` æ‡‰è©²æœƒè¢«å›æ”¶ï¼Œä½†å¯¦éš›ä¸Šä¸¦æ²’æœ‰ã€‚å¯èƒ½æ˜¯å› ç‚º engine ç„¡æ³•åˆ¤æ–· `z.x` æ˜¯å¦åªæ˜¯ä¸€å€‹å–®ç´”çš„å€¼ (æœ‰å¯èƒ½æ˜¯ `z` çš„ä¸€å€‹ `getter function`)ï¼Œå› æ­¤ engine æ²’æœ‰å°‡ `z` å›æ”¶ï¼Œä¹Ÿå°±å°è‡´ `y` ä¹Ÿæ²’æœ‰è¢«å›æ”¶ã€‚

```js live noInline
const registry = new FinalizationRegistry((message) => console.log(message));

function example() {
  console.log("example() is running, waiting for GC...");

  const x = {};
  const y = {};
  const z = { x, y };
  registry.register(x, "x has been collected");
  registry.register(y, "y has been collected");
  registry.register(z, "z has been collected");

  globalThis.temp = () => z.x;
}

render(<button onClick={example}>Open console and click me</button>);
```

```bash title="The output in the console will be:"
example() is running, waiting for GC...
```

## Example 3: Eval

åœ¨ç¬¬ä¸‰å€‹ç¯„ä¾‹ï¼Œæˆ‘å€‘å°‡ `eval function` è¨­ç‚º `globalThis.temp`ã€‚ç”±æ–¼ `eval` å¯ä»¥åŸ·è¡Œä»»ä½•ç¨‹å¼ç¢¼ï¼Œå› æ­¤ engine ä¸¦ä¸çŸ¥é“ `eval` æœƒåŸ·è¡Œä»€éº¼ç¨‹å¼ç¢¼ï¼Œå› æ­¤å®ƒç„¡æ³•åˆ¤æ–·åŒæ¨£ä½åœ¨ `example()` ä¸­çš„ `x` æ˜¯å¦é‚„æœƒè¢«ä½¿ç”¨ã€‚å› æ­¤ `x` ä¸æœƒè¢«å›æ”¶ã€‚

äº‹å¯¦ä¸Šï¼Œå°±ç®—æˆ‘å€‘å°‡ `globalThis.temp` è¨­ç‚º `() => eval(1)`ï¼Œ`x` ä¹Ÿä¸æœƒè¢«å›æ”¶ã€‚å› ç‚º engine å¯èƒ½åªè¦çœ‹åˆ° `eval` å°±æœƒå°‡æ‰€æœ‰åœ¨ `example()` ä¸­çš„è®Šæ•¸éƒ½ä¿ç•™ä¸‹ä¾†ã€‚

```js live noInline
const registry = new FinalizationRegistry((message) => console.log(message));

function example() {
  console.log("example() is running, waiting for GC...");

  const x = {};
  registry.register(x, "x has been collected");

  globalThis.temp = (string) => eval(string);
}

render(<button onClick={example}>Open console and click me</button>);
```

```bash title="The output in the console will be:"
example() is running, waiting for GC...
```

## Example 4: DOM Elements

é€™å€‹ç¯„ä¾‹å’Œç¬¬ä¸€å€‹å¾ˆåƒï¼Œåªæ˜¯æ”¹ç”¨ DOM element ä¾†ä»£æ›¿ plain objectã€‚ä¸åŒæ–¼ plain objectï¼ŒDOM element æœƒæœ‰é€£çµåˆ°å®ƒçš„ parent å’Œ siblingã€‚æ‰€ä»¥æˆ‘å€‘å¯ä»¥é€é `globalThis.temp.parentElement` ä¾†å–å¾— `z`ï¼Œé€é `globalThis.temp.nextSibling` ä¾†å–å¾— `y`ã€‚å› æ­¤ `z` å’Œ `y` éƒ½ä¸æœƒè¢«å›æ”¶ã€‚

å¦‚æœæˆ‘å€‘åŸ·è¡Œ `temp.remove()`ï¼Œ`y` å’Œ `z` å°‡æœƒè¢«å›æ”¶ï¼Œå› ç‚º `x` å·²ç¶“å¾å®ƒçš„ parent ä¸­åˆ†é›¢ã€‚ä½† `x` ä¸æœƒè¢«å›æ”¶ï¼Œå› ç‚ºå®ƒä»ç„¶è¢« `temp` å¼•ç”¨ã€‚

```js live noInline
const registry = new FinalizationRegistry((message) => console.log(message));

function example() {
  console.log("example() is running, waiting for GC...");

  const x = document.createElement("div");
  const y = document.createElement("div");
  const z = document.createElement("div");

  z.append(x);
  z.append(y);

  registry.register(x, "x has been collected");
  registry.register(y, "y has been collected");
  registry.register(z, "z has been collected");

  globalThis.temp = x;
}

render(<button onClick={example}>Open console and click me</button>);
```

```bash title="The output in the console will be:"
example() is running, waiting for GC...
```
